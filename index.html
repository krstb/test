<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonne und Mond</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png"> 
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <meta name="theme-color" content="#000000">
    <meta name="color-scheme" content="light">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js')
            .catch(err => console.log('SW Fehler:', err));
        });
      }
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html { background-color: #000000 !important; }
        body { background-color: #131797; }
        .app-container { background: #1e293b; border-radius: 2rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .card { background: #f8fafc; border-radius: 1.25rem; transition: all 0.3s ease; border: 1px solid #e2e8f0; color: #1e293b; }
        .tab-active-sun { background: #fbbf24; color: #0f172a; font-weight: 700; border-radius: 0.75rem; }
        .tab-active-moon { background: #94a3b8; color: #ffffff; font-weight: 700; border-radius: 0.75rem; }
        .tab-active-planet { background: #06b6d4; color: #ffffff; font-weight: 700; border-radius: 0.75rem; }
        .tab-inactive { color: #94a3b8; }
        input { color-scheme: dark; border: 1px solid #475569 !important; background: #334155; }
        .altitude-meter { width: 14px; height: 45px; background: #e2e8f0; border-radius: 6px; overflow: hidden; position: relative; border: 1px solid #cbd5e1; }
        .altitude-fill { position: absolute; bottom: 0; width: 100%; transition: height 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #gps-status { font-size: 0.65rem; font-weight: bold; margin-bottom: 1rem; padding: 4px 10px; border-radius: 20px; display: inline-block; }
        .gps-active { background: #064e3b; color: #34d399; border: 1px solid #059669; }
        .gps-fallback { background: #450a0a; color: #f87171; border: 1px solid #b91c1c; }
    </style>
</head>
<body class="flex items-start justify-center min-h-screen p-4 pt-4 text-slate-200 font-sans">

    <div class="app-container p-6 max-w-sm w-full mx-auto text-center border border-slate-700">
        <h1 class="text-xl font-black mb-1 text-white tracking-tight">Astronomische Ereignisse</h1> 
        <div id="gps-status" class="gps-fallback">INITIALISIERUNG...</div>

        <div class="flex space-x-2 mb-6">
            <input type="date" id="date-picker" class="p-2 rounded-xl text-xs w-1/2 outline-none text-white">
            <input type="time" id="time-picker" class="p-2 rounded-xl text-xs w-1/2 outline-none text-white">
        </div>
        
        <div id="tab-bar" class="flex p-1 bg-slate-800 rounded-xl mb-8">
            <button data-view="sun" id="btn-sun" class="flex-1 py-2 text-sm transition tab-active-sun">Sonne</button>
            <button data-view="moon" id="btn-moon" class="flex-1 py-2 text-sm transition tab-inactive">Mond</button>
            <button data-view="planet" id="btn-planet" class="flex-1 py-2 text-sm transition tab-inactive">Planeten</button>
        </div>

        <div id="views-container" class="space-y-4">
            <div id="sun-view" class="space-y-4">
                <div class="card p-5 shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <div class="text-left">
                            <span class="block text-[10px] text-emerald-600 uppercase font-black tracking-widest">Aufgang</span>
                            <span id="sunrise-time" class="text-xl font-bold">--:--</span>
                        </div>
                        <div class="text-center px-2 border-x border-slate-200">
                            <span class="block text-[10px] text-amber-600 uppercase font-black tracking-widest">HÃ¶chststand</span>
                            <span id="sun-transit" class="text-xl font-bold">--:--</span>
                        </div>
                        <div class="text-right">
                            <span class="block text-[10px] text-rose-600 uppercase font-black tracking-widest">Untergang</span>
                            <span id="sunset-time" class="text-xl font-bold">--:--</span>
                        </div>
                    </div>
                </div>
                <div class="card p-4 flex items-center space-x-5 shadow-md">
                    <div class="altitude-meter"><div id="sun-alt-fill" class="altitude-fill bg-amber-500"></div></div>
                    <div class="text-left">
                        <span class="text-sm text-amber-600 uppercase font-black">Sonnenstand</span>
                        <p class="text-sm font-bold text-slate-700" id="sun-azimuth">--</p>
                        <p class="text-sm text-slate-500 font-medium">HÃ¶he: <span id="sun-altitude" class="text-amber-600 font-bold">--</span></p>
                    </div>
                </div>
            </div>

            <div id="moon-view" class="hidden space-y-4">
                <div class="card p-5 shadow-md">
                    <div class="flex items-center justify-between">
                        <div id="moon-phase-emoji" class="text-5xl">ðŸŒ‘</div>
                        <div class="text-right">
                            <p id="moon-phase-text" class="text-sm font-black uppercase tracking-tighter text-slate-800"></p>
                            <div class="mt-2 py-1 px-3 bg-slate-200 rounded-md">
                                <p class="text-sm text-slate-500 uppercase font-bold">Vollmond am</p>
                                <p id="next-full-moon" class="text-sm font-bold text-sky-700"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card p-4 flex items-center space-x-5 shadow-md">
                    <div class="altitude-meter"><div id="moon-alt-fill" class="altitude-fill bg-slate-400"></div></div>
                    <div class="text-left">
                        <span class="text-sm text-slate-500 uppercase font-black">Mondstand</span>
                        <p class="text-sm font-bold text-slate-700" id="moon-azimuth">--</p>
                        <p class="text-sm text-slate-500 font-medium">HÃ¶he: <span id="moon-altitude" class="text-slate-700 font-bold">--</span></p>
                    </div>
                </div>
            </div>
            
            <div id="planet-view" class="hidden space-y-2"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/suncalc@1.8.0/suncalc.js"></script>
    <script>
        // GPS & Koordinaten Logik (aus fotolicht.html)
        const stdLat = 48.3631, stdLng = 10.8444; // Stadtbergen Standard
        const savedCoords = localStorage.getItem('sonnemond_coords');
        const initialCoords = savedCoords ? JSON.parse(savedCoords) : { lat: stdLat, lng: stdLng };
        
        let LAT = initialCoords.lat;
        let LON = initialCoords.lng;
        let isGpsActive = false;
        let lastUpdateTimestamp = 0;

        let currentView = 'sun';
        let isUserEditing = false;
        let autoUpdateActive = true;

        function updateStatusDisplay() {
            const statusDiv = document.getElementById('gps-status');
            const label = isGpsActive ? "ðŸŸ¢ GPS AKTIV" : (LAT === stdLat ? "ðŸ”´ STADTBERGEN" : "ðŸ”´ GESPEICHERT");
            statusDiv.className = isGpsActive ? "gps-active" : "gps-fallback";
            statusDiv.innerHTML = `${label} <span style="opacity:0.7; font-size:0.6rem; margin-left:5px;">${LAT.toFixed(4)} , ${LON.toFixed(4)}</span>`;
        }

        function updateLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (p) => {
                        const newLat = p.coords.latitude;
                        const newLng = p.coords.longitude;
                        lastUpdateTimestamp = Date.now();

                        // Update nur bei signifikanter Ã„nderung oder erstem GPS-Fix
                        if (!isGpsActive || Math.abs(newLat - LAT) > 0.005 || Math.abs(newLng - LON) > 0.005) {
                            LAT = newLat;
                            LON = newLng;
                            isGpsActive = true;
                            localStorage.setItem('sonnemond_coords', JSON.stringify({ lat: LAT, lng: LON }));
                            updateStatusDisplay();
                            update(); // Berechnungen mit neuen Koordinaten triggern
                        }
                        setTimeout(updateLocation, 15000);
                    },
                    (error) => {
                        isGpsActive = false;
                        updateStatusDisplay();
                        setTimeout(updateLocation, 15000);
                    },
                    { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
                );
            }
        }

        // Astronomische Berechnungen
        function getCompass(deg) {
            const s = ["N", "NNO", "NO", "ONO", "O", "OSO", "SO", "SSO", "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"];
            return s[(Math.floor((deg / 22.5) + 0.5) % 16)];
        }

        function getNextFullMoon(startDate) {
    let checkDate = new Date(startDate);
    let maxFraction = 0;
    let bestDate = null;
    let isRising = false;

    // Wir suchen in den nÃ¤chsten 32 Tagen stÃ¼ndlich
    for (let i = 0; i < 32 * 24; i++) {
        let date = new Date(checkDate.getTime() + i * 3600000);
        let illumination = SunCalc.getMoonIllumination(date);
        
        // 1. Wir mÃ¼ssen warten, bis die Beleuchtung anfÃ¤ngt zu steigen
        // (um nicht ein Maximum in der unmittelbaren Vergangenheit zu fangen)
        if (i > 0) {
            let prevDate = new Date(date.getTime() - 3600000);
            let prevIllum = SunCalc.getMoonIllumination(prevDate);
            if (illumination.fraction > prevIllum.fraction) {
                isRising = true;
            }
        }

        // 2. Wenn sie steigt, suchen wir den hÃ¶chsten Punkt
        if (isRising) {
            if (illumination.fraction > maxFraction) {
                maxFraction = illumination.fraction;
                bestDate = date;
            } else if (maxFraction > 0.98) { 
                // Sobald die Beleuchtung wieder sinkt UND wir Ã¼ber 98% waren, 
                // haben wir den Vollmond gefunden.
                break;
            }
        }
    }

    if (bestDate) {
        return bestDate.toLocaleDateString('de-DE') + ' ' + 
               bestDate.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
    }
    return "Berechne...";
}


        function getPlanetRealPos(id, date) {
            const d = (date.getTime() / 86400000) - (new Date('2000-01-01T12:00:00Z').getTime() / 86400000);
            const rev = x => x - Math.floor(x / 360.0) * 360.0;
            const rad = x => x * Math.PI / 180.0;
            const deg = x => x * 180.0 / Math.PI;

            const Ms = rev(356.047 + 0.9856002585 * d);
            const Ls = rev(282.9404 + Ms);
            const xs = Math.cos(rad(Ls)), ys = Math.sin(rad(Ls));

            let p = id === 'venus'   ? {a:0.7233, e:0.0067, M:rev(48.005+1.60213*d), N:76.68, i:3.39, w:54.89} :
                    id === 'mars'    ? {a:1.5236, e:0.0934, M:rev(18.602+0.5240*d), N:49.56, i:1.85, w:286.5} :
                    id === 'jupiter' ? {a:5.2026, e:0.0485, M:rev(19.895+0.083085*d), N:100.45, i:1.303, w:273.87} :
                                       {a:9.5547, e:0.0555, M:rev(316.967+0.03344*d), N:113.72, i:2.489, w:339.39};

            const E = rad(p.M + deg(p.e * Math.sin(rad(p.M)) * (1 + p.e * Math.cos(rad(p.M)))));
            const xv = p.a * (Math.cos(E) - p.e), yv = p.a * (Math.sqrt(1 - p.e*p.e) * Math.sin(E));
            const r = Math.sqrt(xv*xv + yv*yv), lonP = rev(deg(Math.atan2(yv, xv)) + p.w);

            const xh = r * (Math.cos(rad(p.N)) * Math.cos(rad(lonP)) - Math.sin(rad(p.N)) * Math.sin(rad(lonP)) * Math.cos(rad(p.i)));
            const yh = r * (Math.sin(rad(p.N)) * Math.cos(rad(lonP)) + Math.cos(rad(p.N)) * Math.sin(rad(lonP)) * Math.cos(rad(p.i)));
            const zh = r * (Math.sin(rad(lonP)) * Math.sin(rad(p.i)));

            const xg = xh + xs, yg = yh + ys, zg = zh;
            const ecl = rad(23.4393);
            const xeq = xg, yeq = yg*Math.cos(ecl)-zg*Math.sin(ecl), zeq = yg*Math.sin(ecl)+zg*Math.cos(ecl);

            const ra = rev(deg(Math.atan2(yeq, xeq))), dec = deg(Math.atan2(zeq, Math.sqrt(xeq*xeq + yeq*yeq)));
            const GMST = rev(280.4606 + 360.9856473 * d);
            const sidereal = rev(GMST + LON);
            const ha = rad(rev(sidereal - ra));
            
            const alt = deg(Math.asin(Math.sin(rad(LAT)) * Math.sin(rad(dec)) + Math.cos(rad(LAT)) * Math.cos(rad(dec)) * Math.cos(ha)));
            const az = rev(deg(Math.atan2(Math.sin(ha), Math.cos(ha) * Math.sin(rad(LAT)) - Math.tan(rad(dec)) * Math.cos(rad(LAT)))) + 180);
            return { azimuth: az, altitude: alt };
        }

        function update() {
            const dateVal = document.getElementById('date-picker').value;
            const timeVal = document.getElementById('time-picker').value;
            const targetDate = new Date(`${dateVal}T${timeVal}`);

            const sT = SunCalc.getTimes(targetDate, LAT, LON);
            const sP = SunCalc.getPosition(targetDate, LAT, LON);
            const mP = SunCalc.getMoonPosition(targetDate, LAT, LON);
            const mI = SunCalc.getMoonIllumination(targetDate);

            document.getElementById('sunrise-time').textContent = sT.sunrise.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
            document.getElementById('sunset-time').textContent = sT.sunset.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
            document.getElementById('sun-transit').textContent = sT.solarNoon.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
            
            const sAlt = Math.round(sP.altitude * 180/Math.PI);
            document.getElementById('sun-altitude').textContent = sAlt + 'Â°';
            document.getElementById('sun-alt-fill').style.height = Math.max(0, sAlt) / 90 * 100 + '%';
            document.getElementById('sun-azimuth').textContent = getCompass(sP.azimuth * 180/Math.PI + 180) + ' (' + Math.round(sP.azimuth * 180/Math.PI + 180) + 'Â°)';

            const mAlt = Math.round(mP.altitude * 180/Math.PI);
            document.getElementById('moon-altitude').textContent = mAlt + 'Â°';
            document.getElementById('moon-alt-fill').style.height = Math.max(0, mAlt) / 90 * 100 + '%';
            document.getElementById('moon-azimuth').textContent = getCompass(mP.azimuth * 180/Math.PI + 180) + ' (' + Math.round(mP.azimuth * 180/Math.PI + 180) + 'Â°)';
            
            document.getElementById('moon-phase-emoji').textContent = ['ðŸŒ‘','ðŸŒ’','ðŸŒ“','ðŸŒ”','ðŸŒ•','ðŸŒ–','ðŸŒ—','ðŸŒ˜'][Math.floor(mI.phase*8)%8];
            const phaseNames = ['Neumond', 'Zunehmend', 'Erstes Viertel', 'Zunehmend', 'Vollmond', 'Abnehmend', 'Letztes Viertel', 'Abnehmend'];
            document.getElementById('moon-phase-text').textContent = phaseNames[Math.floor(mI.phase*8)%8];
            document.getElementById('next-full-moon').textContent = getNextFullMoon(targetDate);

            if(currentView === 'planet') {
                const ps = [
                    {id:'venus', n:'Venus', e:'â™€ï¸', c:'#0891b2'}, 
                    {id:'mars', n:'Mars', e:'â™‚ï¸', c:'#dc2626'}, 
                    {id:'jupiter', n:'Jupiter', e:'â™ƒ', c:'#7c3aed'},
                    {id:'saturn', n:'Saturn', e:'â™„', c:'#b45309'}
                ];
                document.getElementById('planet-view').innerHTML = ps.map(p => {
                    const pos = getPlanetRealPos(p.id, targetDate);
                    const h = Math.round(pos.altitude);
                    return `<div class="card p-3 flex items-center space-x-5 shadow-sm" style="border-left: 6px solid ${p.c}">
                        <div class="altitude-meter"><div class="altitude-fill" style="height: ${Math.max(0, h)/90*100}%; background-color: ${p.c}"></div></div>
                        <div class="text-left leading-tight">
                            <span class="text-sm uppercase font-black" style="color: ${p.c}">${p.n} ${p.e}</span>
                            <p class="text-sm font-bold text-slate-700">${getCompass(pos.azimuth)} (${Math.round(pos.azimuth)}Â°)</p>
                            <p class="text-sm text-slate-500 font-medium">HÃ¶he: <span style="color: ${p.c}" class="font-bold">${h}Â°</span></p>
                        </div>
                    </div>`;
                }).join('');
            }
        }

        function tick() {
            if (isUserEditing || !autoUpdateActive) return;
            const now = new Date();
            const dateInput = document.getElementById('date-picker');
            const timeInput = document.getElementById('time-picker');
            const todayStr = now.toLocaleDateString('en-CA');
            const currentTimeStr = now.toTimeString().slice(0,5);
            let changed = false;
            if (dateInput.value !== todayStr) { dateInput.value = todayStr; changed = true; }
            if (timeInput.value !== currentTimeStr) { timeInput.value = currentTimeStr; changed = true; }
            if (changed) update();
        }

        // Event Listener & Initialisierung
        const datePicker = document.getElementById('date-picker');
        const timePicker = document.getElementById('time-picker');

        [datePicker, timePicker].forEach(picker => {
            picker.addEventListener('focus', () => { isUserEditing = true; });
            picker.addEventListener('blur', () => { isUserEditing = false; });
            picker.addEventListener('input', () => { autoUpdateActive = false; update(); });
        });

        document.querySelectorAll('[data-view]').forEach(t => t.addEventListener('click', e => {
            currentView = e.target.dataset.view;
            const btns = { sun: 'btn-sun', moon: 'btn-moon', planet: 'btn-planet' };
            Object.keys(btns).forEach(key => {
                document.getElementById(btns[key]).className = `flex-1 py-2 text-sm transition ${key === currentView ? 'tab-active-' + key : 'tab-inactive'}`;
            });
            ['sun-view','moon-view','planet-view'].forEach(v => document.getElementById(v).classList.toggle('hidden', v !== currentView + '-view'));
            update();
        }));

        const initialNow = new Date();
        document.getElementById('date-picker').value = initialNow.toLocaleDateString('en-CA');
        document.getElementById('time-picker').value = initialNow.toTimeString().slice(0,5);
        
        updateStatusDisplay();
        update();
        updateLocation(); // GPS starten
        setInterval(tick, 1000);
    </script>
</body>
</html>
