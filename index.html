<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>W채hrungsumrechner</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="icon-192.png"> 
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <meta name="theme-color" content="#000000">
  <meta name="color-scheme" content="light">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="icon-192.png">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').catch(err => console.log('SW Fehler:', err));
      });
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    html {background-color: #000000 !important;}
    body { font-family: 'Inter', sans-serif; background-color: #D2FF00; }
    .shadow-3xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
  </style>
</head>
<body class="flex items-start justify-center min-h-screen p-4 pt-4">
  <div class="bg-white p-8 rounded-3xl shadow-3xl w-full max-w-lg border border-gray-100">
    <h1 class="text-3xl font-bold text-center text-slate-800 mb-8">W채hrung</h1>
    <div class="mb-6">
      <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Betrag</label>
      <input type="text" id="amount" placeholder="z. B. 1.250,50"
             class="mt-1 block w-full px-4 py-3 border-2 border-gray-300 rounded-xl shadow-inner focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
    </div>
    <div class="flex flex-col md:flex-row items-center justify-between space-y-6 md:space-y-0 md:space-x-4 mb-8">
      <div class="relative w-full md:w-5/12">
        <label for="from-currency" class="block text-sm font-medium text-gray-700 mb-1">Von</label>
        <select id="from-currency" class="mt-1 block w-full px-4 py-3 border-2 border-gray-300 rounded-xl shadow-inner appearance-none bg-white cursor-pointer pr-10"></select>
      </div>
      <button id="swap-btn" class="p-3 rounded-full bg-blue-500 hover:bg-blue-600 shadow-lg">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
      </button>
      <div class="relative w-full md:w-5/12">
        <label for="to-currency" class="block text-sm font-medium text-gray-700 mb-1">Zu</label>
        <select id="to-currency" class="mt-1 block w-full px-4 py-3 border-2 border-gray-300 rounded-xl shadow-inner appearance-none bg-white cursor-pointer pr-10"></select>
      </div>
    </div>
    <div id="result" class="mt-8 text-center text-xl font-bold text-gray-800 min-h-[4rem] bg-gray-50 p-4 rounded-xl border border-gray-200 shadow-sm">&nbsp;</div>
  </div>

  <script>
    const amountInput = document.getElementById('amount');
    const fromCurrencySelect = document.getElementById('from-currency');
    const toCurrencySelect = document.getElementById('to-currency');
    const swapBtn = document.getElementById('swap-btn');
    const resultDiv = document.getElementById('result');

    function formatNumber(number) {
        return new Intl.NumberFormat('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(number);
    }

    function handleInput(e) {
        let cursorPosition = e.target.selectionStart;
        let originalValue = e.target.value;
        
        // Erlaube nur Ziffern und ein einzelnes Komma
        let cleanValue = originalValue.replace(/[^0-9,]/g, '');
        
        // Verhindere mehrere Kommas
        const parts = cleanValue.split(',');
        if (parts.length > 2) cleanValue = parts[0] + ',' + parts.slice(1).join('');

        let [integerPart, decimalPart] = cleanValue.split(',');

        // Tausenderpunkte im Ganzzahlteil setzen
        if (integerPart) {
            integerPart = parseInt(integerPart).toLocaleString('de-DE');
        }

        // Wert zusammensetzen
        let newValue = integerPart !== undefined ? integerPart : '';
        if (cleanValue.includes(',')) newValue += ',' + (decimalPart || '');

        e.target.value = newValue;

        // Cursor-Logik (vereinfacht f체r manuelle Komma-Eingabe)
        if (originalValue !== newValue) {
            cursorPosition = cursorPosition + (newValue.length - originalValue.length);
        }
        e.target.setSelectionRange(cursorPosition, cursorPosition);

        convertCurrency();
    }

    async function populateCurrencyDropdowns() {
      try {
        const response = await fetch('https://open.er-api.com/v6/latest/EUR');
        const data = await response.json();
        if (data.result === 'success') {
          const currencies = Object.keys(data.rates).sort();
          currencies.forEach(currency => {
            fromCurrencySelect.add(new Option(currency, currency));
            toCurrencySelect.add(new Option(currency, currency));
          });
          fromCurrencySelect.value = localStorage.getItem('fromCurrency') || 'USD';
          toCurrencySelect.value = localStorage.getItem('toCurrency') || 'EUR';
        }
      } catch (e) { console.error(e); }
    }

    async function convertCurrency() {
      // Normalisierung f체r JS-Berechnung (Punkte weg, Komma zu Punkt)
      const rawValue = amountInput.value.replace(/\./g, '').replace(',', '.');
      const amount = parseFloat(rawValue);
      
      localStorage.setItem('fromCurrency', fromCurrencySelect.value);
      localStorage.setItem('toCurrency', toCurrencySelect.value);
      localStorage.setItem('lastAmount', amountInput.value);

      if (isNaN(amount) || amount <= 0) { resultDiv.innerHTML = '&nbsp;'; return; }
      
      try {
        const response = await fetch(`https://open.er-api.com/v6/latest/${fromCurrencySelect.value}`);
        const data = await response.json();
        const rate = data.rates[toCurrencySelect.value];
        if (rate) {
          const res = amount * rate;
          resultDiv.innerHTML = `${amountInput.value} ${fromCurrencySelect.value}<br>=<br>${formatNumber(res)} ${toCurrencySelect.value}`;
        }
      } catch (e) { resultDiv.textContent = 'Fehler.'; }
    }

    window.onload = () => {
        populateCurrencyDropdowns().then(() => {
            const last = localStorage.getItem('lastAmount');
            if (last) { amountInput.value = last; convertCurrency(); }
        });
        amountInput.addEventListener('input', handleInput);
        fromCurrencySelect.addEventListener('change', convertCurrency);
        toCurrencySelect.addEventListener('change', convertCurrency);
        swapBtn.addEventListener('click', () => {
            const temp = fromCurrencySelect.value;
            fromCurrencySelect.value = toCurrencySelect.value;
            toCurrencySelect.value = temp;
            convertCurrency();
        });
    };
  </script>
</body>
</html>
